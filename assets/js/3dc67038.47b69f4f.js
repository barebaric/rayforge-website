"use strict";(self.webpackChunkwebsite_new=self.webpackChunkwebsite_new||[]).push([[8321],{33331(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"developer/tasker","title":"Tasker: Background Task Management","description":"tasker is a module for running long-running tasks in the background of a GTK application without freezing the UI. It provides a simple, unified API for both I/O-bound (asyncio) and CPU-bound (multiprocessing) work.","source":"@site/docs/developer/tasker.md","sourceDirName":"developer","slug":"/developer/tasker","permalink":"/docs/developer/tasker","draft":false,"unlisted":false,"editUrl":"https://github.com/barebaric/rayforge/tree/main/website/docs/docs/developer/tasker.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Pipeline Architecture","permalink":"/docs/developer/pipeline"},"next":{"title":"Driver Development Guide","permalink":"/docs/developer/driver"}}');var r=s(74848),a=s(28453);const o={},i="Tasker: Background Task Management",c={},d=[{value:"Core Concepts",id:"core-concepts",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Running an I/O-Bound Task (e.g., network, file access)",id:"running-an-io-bound-task-eg-network-file-access",level:3},{value:"Running a CPU-Bound Task (e.g., heavy computation)",id:"running-a-cpu-bound-task-eg-heavy-computation",level:3},{value:"Running a Thread-Bound Task",id:"running-a-thread-bound-task",level:3},{value:"Essential Patterns",id:"essential-patterns",level:2},{value:"Updating the UI",id:"updating-the-ui",level:3},{value:"Cancellation",id:"cancellation",level:3},{value:"Handling Completion",id:"handling-completion",level:3},{value:"API Reference",id:"api-reference",level:2},{value:"<code>task_mgr</code> (The Manager Proxy)",id:"task_mgr-the-manager-proxy",level:3},{value:"<code>context</code> (Inside your background function)",id:"context-inside-your-background-function",level:3},{value:"Usage in Rayforge",id:"usage-in-rayforge",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"tasker-background-task-management",children:"Tasker: Background Task Management"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"tasker"})," is a module for running long-running tasks in the background of a GTK application without freezing the UI. It provides a simple, unified API for both I/O-bound (",(0,r.jsx)(n.code,{children:"asyncio"}),") and CPU-bound (",(0,r.jsx)(n.code,{children:"multiprocessing"}),") work."]}),"\n",(0,r.jsx)(n.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"task_mgr"})}),": The global singleton proxy you use to start and cancel all tasks"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"Task"})}),": An object representing a single background job. You use it to track status"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:[(0,r.jsx)(n.code,{children:"ExecutionContext"})," (",(0,r.jsx)(n.code,{children:"context"}),")"]}),": An object passed as the first argument to your background function. Your code uses it to report progress, send messages, and check for cancellation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"TaskManagerProxy"})}),": A thread-safe proxy that forwards calls to the actual TaskManager running in the main thread"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,r.jsxs)(n.p,{children:["All background tasks are managed by the global ",(0,r.jsx)(n.code,{children:"task_mgr"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"running-an-io-bound-task-eg-network-file-access",children:"Running an I/O-Bound Task (e.g., network, file access)"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"add_coroutine"})," for ",(0,r.jsx)(n.code,{children:"async"})," functions. These are lightweight and ideal for tasks that wait for I/O."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import asyncio\nfrom rayforge.shared.tasker import task_mgr\n\n# Your background function MUST accept `context` as the first argument.\nasync def my_io_task(context, url):\n    context.set_message("Downloading...")\n    # ... perform async download ...\n    await asyncio.sleep(2) # Simulate work\n    context.set_progress(1.0)\n    context.set_message("Download complete!")\n\n# Start the task from your UI code (e.g., a button click)\ntask_mgr.add_coroutine(my_io_task, "http://example.com", key="downloader")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"running-a-cpu-bound-task-eg-heavy-computation",children:"Running a CPU-Bound Task (e.g., heavy computation)"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"run_process"})," for regular functions. These run in a separate process to avoid the GIL and keep the UI responsive."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import time\nfrom rayforge.shared.tasker import task_mgr\n\n# A regular function, not async.\ndef my_cpu_task(context, iterations):\n    context.set_total(iterations)\n    context.set_message("Calculating...")\n    for i in range(iterations):\n        # ... perform heavy calculation ...\n        time.sleep(0.1) # Simulate work\n        context.set_progress(i + 1)\n    return "Final Result"\n\n# Start the task\ntask_mgr.run_process(my_cpu_task, 50, key="calculator")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"running-a-thread-bound-task",children:"Running a Thread-Bound Task"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"run_thread"})," for tasks that should run in a thread but don't require the full process isolation. This is useful for tasks that share memory but still shouldn't block the UI."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'import time\nfrom rayforge.shared.tasker import task_mgr\n\n# A regular function that will run in a thread\ndef my_thread_task(context, duration):\n    context.set_message("Working in thread...")\n    time.sleep(duration) # Simulate work\n    context.set_progress(1.0)\n    return "Thread task complete"\n\n# Start the task in a thread\ntask_mgr.run_thread(my_thread_task, 2, key="thread_worker")\n'})}),"\n",(0,r.jsx)(n.h2,{id:"essential-patterns",children:"Essential Patterns"}),"\n",(0,r.jsx)(n.h3,{id:"updating-the-ui",children:"Updating the UI"}),"\n",(0,r.jsxs)(n.p,{children:["Connect to the ",(0,r.jsx)(n.code,{children:"tasks_updated"})," signal to react to changes. The handler will be safely called on the main GTK thread."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'def setup_ui(progress_bar, status_label):\n    # This handler updates the UI based on the overall progress\n    def on_tasks_updated(sender, tasks, progress):\n        progress_bar.set_fraction(progress)\n        if tasks:\n            status_label.set_text(tasks[-1].get_message() or "Working...")\n        else:\n            status_label.set_text("Idle")\n\n    task_mgr.tasks_updated.connect(on_tasks_updated)\n\n# Later in your UI...\n# setup_ui(my_progress_bar, my_label)\n'})}),"\n",(0,r.jsx)(n.h3,{id:"cancellation",children:"Cancellation"}),"\n",(0,r.jsxs)(n.p,{children:["Give your tasks a ",(0,r.jsx)(n.code,{children:"key"})," to cancel them later. Your background function should periodically check ",(0,r.jsx)(n.code,{children:"context.is_cancelled()"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'# In your background function:\nif context.is_cancelled():\n    print("Task was cancelled, stopping work.")\n    return\n\n# In your UI code:\ntask_mgr.cancel_task("calculator")\n'})}),"\n",(0,r.jsx)(n.h3,{id:"handling-completion",children:"Handling Completion"}),"\n",(0,r.jsxs)(n.p,{children:["Use the ",(0,r.jsx)(n.code,{children:"when_done"})," callback to get the result or see if an error occurred."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"def on_task_finished(task):\n    if task.get_status() == 'completed':\n        print(f\"Task finished with result: {task.result()}\")\n    elif task.get_status() == 'failed':\n        print(f\"Task failed: {task._task_exception}\")\n\ntask_mgr.run_process(my_cpu_task, 10, when_done=on_task_finished)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"api-reference",children:"API Reference"}),"\n",(0,r.jsxs)(n.h3,{id:"task_mgr-the-manager-proxy",children:[(0,r.jsx)(n.code,{children:"task_mgr"})," (The Manager Proxy)"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"add_coroutine(coro, *args, key=None, when_done=None)"}),": Add an asyncio-based task"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"run_process(func, *args, key=None, when_done=None, when_event=None)"}),": Run a CPU-bound task in a separate process"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"run_thread(func, *args, key=None, when_done=None)"}),": Run a task in a thread (shares memory with main process)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cancel_task(key)"}),": Cancel a running task by its key"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tasks_updated"})," (signal for UI updates): Emitted when task status changes"]}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"context-inside-your-background-function",children:[(0,r.jsx)(n.code,{children:"context"})," (Inside your background function)"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"set_progress(value)"}),": Report current progress (e.g., ",(0,r.jsx)(n.code,{children:"i + 1"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"set_total(total)"}),": Set the max value for ",(0,r.jsx)(n.code,{children:"set_progress"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'set_message("...")'}),": Update the status text"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"is_cancelled()"}),": Check if you should stop"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"sub_context(...)"}),": Create a sub-task for multi-stage operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'send_event("name", data)'}),": (Process-only) Send custom data back to the UI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"flush()"}),": Immediately send any pending updates to the UI"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"usage-in-rayforge",children:"Usage in Rayforge"}),"\n",(0,r.jsx)(n.p,{children:"The tasker is used throughout Rayforge for:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Pipeline processing"}),": Running the document pipeline in the background"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"File operations"}),": Importing and exporting files without blocking the UI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Device communication"}),": Managing long-running operations with laser cutters"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Image processing"}),": Performing CPU-intensive image tracing and processing"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When working with the tasker in Rayforge, always ensure your background functions properly handle cancellation and provide meaningful progress updates to maintain a responsive user experience."})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},28453(e,n,s){s.d(n,{R:()=>o,x:()=>i});var t=s(96540);const r={},a=t.createContext(r);function o(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);
"use strict";(self.webpackChunkwebsite_new=self.webpackChunkwebsite_new||[]).push([[8247],{23331(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"developer/driver","title":"Driver Development Guide","description":"This guide provides a high-level overview of how to create a driver in Rayforge","source":"@site/docs/developer/driver.md","sourceDirName":"developer","slug":"/developer/driver","permalink":"/docs/developer/driver","draft":false,"unlisted":false,"editUrl":"https://github.com/barebaric/rayforge/tree/main/website/docs/docs/developer/driver.md","tags":[],"version":"current","frontMatter":{},"sidebar":"developerSidebar","previous":{"title":"Tasker: Background Task Management","permalink":"/docs/developer/tasker"},"next":{"title":"Rayforge Package Developer Guide","permalink":"/docs/developer/plugin-docs"}}');var t=s(74848),r=s(28453);const d={},l="Driver Development Guide",o={},c=[{value:"Driver Overview",id:"driver-overview",level:2},{value:"The <code>Ops</code> Language",id:"the-ops-language",level:2},{value:"Driver Implementation",id:"driver-implementation",level:2},{value:"Required Properties",id:"required-properties",level:3},{value:"Required Methods",id:"required-methods",level:3},{value:"Configuration and Lifecycle",id:"configuration-and-lifecycle",level:4},{value:"Device Control",id:"device-control",level:4},{value:"Firmware Settings (if <code>supports_settings</code> is <code>True</code>)",id:"firmware-settings-if-supports_settings-is-true",level:4},{value:"Emitting Signals",id:"emitting-signals",level:3},{value:"Have Questions?",id:"have-questions",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"driver-development-guide",children:"Driver Development Guide"})}),"\n",(0,t.jsx)(n.p,{children:"This guide provides a high-level overview of how to create a driver in Rayforge\nto add support for your laser cutter or engraver. By creating a driver, you\nintegrate your machine's unique communication protocol and command language into\nthe Rayforge ecosystem."}),"\n",(0,t.jsx)(n.h2,{id:"driver-overview",children:"Driver Overview"}),"\n",(0,t.jsx)(n.p,{children:"A driver is the bridge between Rayforge's core logic and your physical hardware.\nIt is responsible for three main tasks:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Managing Connectivity:"})," Handling the low-level communication protocol\n(Serial, WebSocket, HTTP, etc.)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Executing Jobs:"})," Sending pre-encoded machine code (e.g., G-code) to the\ndevice and tracking execution progress."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reporting State:"})," Emitting signals to update the UI with the laser's\nreal-time position, status (",(0,t.jsx)(n.code,{children:"IDLE"}),", ",(0,t.jsx)(n.code,{children:"RUN"}),"), and log messages."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To simplify this, Rayforge provides an architecture based on composable parts:"}),"\n",(0,t.jsx)(n.mermaid,{value:"graph TD;\n    subgraph RayforgeCore[Rayforge Core]\n        OpsProducer--\x3e|Produces| Ops;\n        Pipeline--\x3e|Runs| OpsProducer;\n    end\n\n    subgraph YourDriver[Your Driver Implementation]\n        Ops --\x3e|Encodes via| OpsEncoder;\n        OpsEncoder--\x3e|Produces| MachineCode\n        MachineCode--\x3e|Calls run| Driver;\n        Driver--\x3e|Sends via| Transport;\n    end\n\n    Transport --\x3e Device[Physical Laser];\n\n    classDef clusterBox fill:#fff3e080,stroke:#ffb74d80,stroke-width:1px\n    class RayforgeCore,YourDriver clusterBox"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"OpsEncoder"}),":"]})," Translates ",(0,t.jsx)(n.code,{children:"Ops"})," into a specific command language\n(e.g., G-code). Used by both the Pipeline (for job encoding) and the\nDriver (for individual commands like move_to, home, etc.)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"Pipeline"}),":"]})," Orchestrates encoding and produces final machine code."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"Transport"}),":"]})," Manages the connection and data transfer."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:[(0,t.jsx)(n.code,{children:"Driver"}),":"]})," Executes machine code, handles device state, and communicates\nwith the UI."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["All driver operations are ",(0,t.jsx)(n.strong,{children:"asynchronous"})," to ensure the user interface remains responsive."]}),"\n",(0,t.jsxs)(n.h2,{id:"the-ops-language",children:["The ",(0,t.jsx)(n.code,{children:"Ops"})," Language"]}),"\n",(0,t.jsxs)(n.p,{children:["Rayforge describes a laser job as a sequence of high-level operations, stored in\nan ",(0,t.jsx)(n.code,{children:"Ops"})," object. This is the universal language within Rayforge for describing\nmachine movements, independent of any specific hardware."]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsxs)(n.th,{style:{textAlign:"left"},children:[(0,t.jsx)(n.code,{children:"Ops"})," Method"]}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Signature"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"move_to"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"(x, y, z=0.0)"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Rapid movement (no cutting)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"line_to"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"(x, y, z=0.0)"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Cutting/Engraving movement"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"arc_to"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"(x, y, i, j, cw=True, z=0.0)"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Cutting/Engraving arc movement"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"set_power"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"(power)"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Set laser power (0-100%)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"set_cut_speed"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"(speed)"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Set speed for cutting moves (mm/min)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"set_travel_speed"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"(speed)"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Set speed for rapid moves (mm/min)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"enable_air_assist"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"()"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Turn on air assist"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"disable_air_assist"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"()"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"Turn off air assist"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["Your driver receives pre-encoded machine code (e.g., a G-code string) and an\noperation map that tracks which machine code commands correspond to which\noperations. The pipeline handles encoding ",(0,t.jsx)(n.code,{children:"Ops"})," to machine code before calling\nthe driver's ",(0,t.jsx)(n.code,{children:"run()"})," method."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Example of how Rayforge builds an Ops object\nops = Ops()\nops.set_travel_speed(3000)\nops.set_cut_speed(800)\nops.set_power(80)\n\nops.move_to(10, 10)       # Rapid move to start point\nops.enable_air_assist()\nops.line_to(50, 10)       # Cut a line with air assist\nops.disable_air_assist()\nops.line_to(50, 50)       # Cut a line without air assist\n"})}),"\n",(0,t.jsx)(n.h2,{id:"driver-implementation",children:"Driver Implementation"}),"\n",(0,t.jsxs)(n.p,{children:["All drivers MUST inherit from ",(0,t.jsx)(n.code,{children:"rayforge.machine.drivers.Driver"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from rayforge.machine.driver.driver import Driver\n\nclass YourDriver(Driver):\n    label = "Your Device"  # Display name in the UI\n    subtitle = "Description for users"\n    supports_settings = False # Set True if the driver can read/write firmware settings\n'})}),"\n",(0,t.jsx)(n.h3,{id:"required-properties",children:"Required Properties"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"label"}),": A human-readable name shown in the UI."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"subtitle"}),": A brief description shown below the name."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"supports_settings"}),": A boolean indicating if the driver can read/write device\nsettings (like GRBL's ",(0,t.jsx)(n.code,{children:"$$"}),")."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"required-methods",children:"Required Methods"}),"\n",(0,t.jsxs)(n.p,{children:["Your driver class ",(0,t.jsx)(n.strong,{children:"MUST"})," implement the following methods. Note that most are ",(0,t.jsx)(n.strong,{children:"asynchronous"})," and must be defined with ",(0,t.jsx)(n.code,{children:"async def"}),"."]}),"\n",(0,t.jsx)(n.h4,{id:"configuration-and-lifecycle",children:"Configuration and Lifecycle"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"get_setup_vars() -> VarSet"}),": ",(0,t.jsx)(n.strong,{children:"(Class Method)"})," Returns a ",(0,t.jsx)(n.code,{children:"VarSet"})," object\ndefining the parameters needed for connection (e.g., IP address, serial port).\nRayforge uses this to automatically generate the setup form in the UI."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"precheck(**kwargs)"}),": ",(0,t.jsx)(n.strong,{children:"(Class Method)"})," A non-blocking, static check of the\nconfiguration that can be run before driver instantiation. Should raise\n",(0,t.jsx)(n.code,{children:"DriverPrecheckError"})," on failure."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"setup(**kwargs)"}),": Called once with the values from the setup form. Use this\nto initialize your transports and internal state."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def connect()"}),": Establishes and maintains a persistent connection to\nthe device. This method should contain auto-reconnection logic."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def cleanup()"}),": Called when disconnecting. Should close all\nconnections and release resources."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"device-control",children:"Device Control"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def run(machine_code: Any, op_map: MachineCodeOpMap, doc: Doc, on_command_done: Optional[Callable[[int], Union[None, Awaitable[None]]]] = None)"}),": The core method for executing a job. Receives pre-encoded machine\ncode (e.g., G-code string) and a mapping between operation indices and\nmachine code. The ",(0,t.jsx)(n.code,{children:"on_command_done"})," callback is called with the op_index\nwhen each command completes."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def home(axes: Optional[Axis] = None)"}),": Homes the machine. Can home\nspecific axes or all axes."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def move_to(pos_x: float, pos_y: float)"}),": Manually moves the laser\nhead to a specific XY coordinate."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def set_hold(hold: bool = True)"}),": Pauses or resumes current job."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def cancel()"}),": Stops the current job."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def jog(axis: Axis, distance: float, speed: int)"}),": Jogs the machine\nalong a specific axis."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def select_tool(tool_number: int)"}),": Selects a new tool/laser head by\nits number."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def clear_alarm()"}),": Clears any active alarm state."]}),"\n"]}),"\n",(0,t.jsxs)(n.h4,{id:"firmware-settings-if-supports_settings-is-true",children:["Firmware Settings (if ",(0,t.jsx)(n.code,{children:"supports_settings"})," is ",(0,t.jsx)(n.code,{children:"True"}),")"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"get_setting_vars() -> List[VarSet]"}),": Returns ",(0,t.jsx)(n.code,{children:"VarSet"})," objects that define\nthe structure of the device's settings page."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def read_settings()"}),": Reads all settings from the device and calls\n",(0,t.jsx)(n.code,{children:"_on_settings_read()"})," with the result."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"async def write_setting(key: str, value: Any)"}),": Writes a single setting to\nthe device."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"emitting-signals",children:"Emitting Signals"}),"\n",(0,t.jsxs)(n.p,{children:["To communicate with the UI, your driver must emit signals. To ensure proper\nlogging and thread safety, ",(0,t.jsx)(n.strong,{children:"you must not emit signals directly."})," Instead,\ncall the protected helper methods from the base ",(0,t.jsx)(n.code,{children:"Driver"})," class."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"self._log(message)"}),": Sends a log message to the console."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"self._on_state_changed()"}),": Call this whenever you update ",(0,t.jsx)(n.code,{children:"self.state"})," to\nnotify the UI of a status or position change."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"self._on_connection_status_changed(status, message)"}),": Informs the UI about\nthe connection status (",(0,t.jsx)(n.code,{children:"CONNECTING"}),", ",(0,t.jsx)(n.code,{children:"CONNECTED"}),", ",(0,t.jsx)(n.code,{children:"ERROR"}),", etc.)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"self._on_command_status_changed(status, message)"}),": Reports the status of a\nsent command."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"self._on_settings_read(settings)"}),": Sends the device settings you've read\nback to the UI."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"have-questions",children:"Have Questions?"}),"\n",(0,t.jsxs)(n.p,{children:["The best way to learn is to look at the existing drivers in\n",(0,t.jsx)(n.code,{children:"rayforge/machine/driver/"}),", such as:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"grbl.py"})," - GRBL-based machines"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"grbl_serial.py"})," - Serial-based GRBL communication"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"smoothie.py"})," - Smoothieboard-based machines"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"dummy.py"})," - A test driver for development"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"If you get stuck, please don't hesitate to open an issue on GitHub! We're happy to help."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>d,x:()=>l});var i=s(96540);const t={},r=i.createContext(t);function d(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);